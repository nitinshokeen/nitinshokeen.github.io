$(document).ready(function() {
 $(".button-collapse").sideNav();

 //function to get token from page url
 $.urlParam = function(name) {
  var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
  if (results == null) {
   return null;
  } else {
   return decodeURI(results[1]) || 0;
  }
 }

 var token = $.urlParam('token');
 $(".profileLink").attr("href", "profile.html?token=" + token);
 $(".feedLink").attr("href", "feed.html?token=" + token);
 var posts;
 getinfo();

 function getinfo() {
  $.ajax('https://graph.facebook.com/me?fields=id,name,posts,cover&&access_token=' + token, {
   success: function(response) {
    console.log(typeof(response));
    posts = response.posts.data;
    pictureLink = "http://graph.facebook.com/" + response.id + "/picture?type=normal";
    coverLink = response.cover.source;
   }, //end sucess 
   error: function(request, errorType, errorMessage) {
    console.log(request);
    console.log(errorType);
    Materialize.toast(errorMessage, 3000);
    Materialize.toast("Invalid access token.");
    var $toastContent = $('<span>Please try again.</span>').add($('<button class="btn-flat toast-action"><a href="index.html">Retry</a></button>'));
    Materialize.toast($toastContent);
   }, //end error 

   timeout: 5000,

   beforeSend: function() {

    $('.-loader').show();

   }, //end beforeSend 

   complete: function() {

     $('.loader').hide();
     $('.padding').removeClass("padding");
     $(".profilePic").attr("src", pictureLink);
     console.log(posts);
     console.log("length: " + posts.length);
     //loop to print all recent posts of user.
     for (var i = 0; i < posts.length; i++) {
      if (posts[i].message == undefined) {
       makePost(pictureLink, posts[i].story, posts[i].created_time, "");
      } else if (posts[i].story == undefined) {
       makePost(pictureLink, "", posts[i].created_time, posts[i].message);
      } else {
       makePost(pictureLink, posts[i].story, posts[i].created_time, posts[i].message);
      }
     }
    } //end complete 
  }); //end ajax
 } //end getInfo

 //function to append a row containig a post.
 function makePost(link, story, time, message) {
  var one = '<div class="row card-panel"><div class="col s2" align="center"><img class="circle responsive-img profilePic" src="';
  var two = '"></div><div class="col s10"><div class="row"><div class="col s10 left"><h5>';
  var three = '</h5></div><div class="col s10">';
  var four = '</div></div></div><div class="col s12 flow-text center-align">';
  var five = '</div></div>';
  $(".postsContainer").append(one + link + two + story + three + time + four + message + five);
 };

});